<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººçœ¼æˆåƒä¸è§†åŠ›çŸ«æ­£æ¼”ç¤º - åˆä¸­ç‰©ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 16px;
        }
        
        .main-area {
            display: flex;
            gap: 25px;
            margin-top: 25px;
        }
        
        .canvas-container {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        canvas {
            display: block;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: #f8f9fa;
            width: 100%;
        }
        
        .control-panel {
            width: 340px;
            background: #ecf0f1;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            background: #bdc3c7;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .control-group .value-display {
            display: inline-block;
            float: right;
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .status-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .status-display strong {
            color: #d63031;
            font-size: 15px;
        }
        
        .legend {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }
        
        .auto-adjust-btn {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auto-adjust-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .auto-adjust-btn:active {
            transform: translateY(0);
        }
        
        .auto-adjust-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .slider-container {
            position: relative;
        }
        
        .slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .thickness-info {
            margin-top: 8px;
            padding: 8px;
            background: #e8f5e9;
            border-left: 3px solid #27ae60;
            border-radius: 3px;
            font-size: 12px;
            color: #2c3e50;
        }
        
        .thickness-info strong {
            color: #27ae60;
        }
        
        .note {
            margin-top: 10px;
            padding: 8px;
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            border-radius: 3px;
            font-size: 11px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘ï¸ äººçœ¼æˆåƒä¸è§†åŠ›çŸ«æ­£äº¤äº’æ¼”ç¤º</h1>
        <p class="subtitle">ç‰©ç†æ•™å­¦ Â· å‡¸é€é•œæˆåƒ Â· è¿‘è§†ä¸è¿œè§†çš„å½¢æˆä¸çŸ«æ­£</p>
        
        <div class="main-area">
            <div class="canvas-container">
                <canvas id="eyeCanvas" width="900" height="500"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12; width: 15px; height: 15px; border-radius: 50%;"></div>
                        <span>ç‚¹å…‰æºï¼ˆç‰©ä½“ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #c0392b; height: 2px;"></div>
                        <span>å…¥å°„å…‰çº¿</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>æŠ˜å°„å…‰çº¿ï¼ˆçœ¼å†…ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #27ae60; height: 5px;"></div>
                        <span>æˆåƒä½ç½®</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db; height: 5px;"></div>
                        <span>è§†ç½‘è†œä½ç½®</span>
                    </div>
                    <div class="note">
                        ğŸ’¡ æç¤ºï¼šä¸ºä¾¿äºè§‚å¯Ÿï¼Œåƒçš„ä½ç½®åå·®å·²æ”¾å¤§5å€æ˜¾ç¤º
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ›ï¸ æ§åˆ¶é¢æ¿</h2>
                
                <div class="control-group">
                    <label>çœ¼ç›ç±»å‹</label>
                    <select id="eyeType">
                        <option value="normal">æ­£å¸¸çœ¼ï¼ˆæ­£è§†ï¼‰</option>
                        <option value="myopia">è¿‘è§†çœ¼</option>
                        <option value="hyperopia">è¿œè§†çœ¼</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>
                        ç‰©è·ï¼ˆcmï¼‰
                        <span class="value-display" id="distanceValue">200</span>
                    </label>
                    <div class="slider-container">
                        <input type="range" id="objectDistance" min="20" max="500" value="200" step="10">
                        <div class="slider-marks">
                            <span>20</span>
                            <span>100</span>
                            <span>200</span>
                            <span>300</span>
                            <span>500</span>
                        </div>
                    </div>
                    <small style="color: #7f8c8d;">ç‰©ä½“è·ç¦»çœ¼ç›çš„è·ç¦»</small>
                </div>
                
                <div class="control-group">
                    <button class="auto-adjust-btn" id="autoAdjustBtn">
                        ğŸ¯ è‡ªåŠ¨è°ƒèŠ‚æ™¶çŠ¶ä½“ï¼ˆçœ‹æ¸…ç‰©ä½“ï¼‰
                    </button>
                </div>
                
                <div class="control-group">
                    <label>
                        æ™¶çŠ¶ä½“åšåº¦è°ƒèŠ‚
                        <span class="value-display" id="thicknessValue">50.0</span>
                    </label>
                    <div class="slider-container">
                        <input type="range" id="lensThickness" min="0" max="100" value="50" step="0.1">
                        <div class="slider-marks">
                            <span>0<br>(æœ€è–„)</span>
                            <span>25</span>
                            <span>50</span>
                            <span>75</span>
                            <span>100<br>(æœ€åš)</span>
                        </div>
                    </div>
                    <small style="color: #7f8c8d;">è°ƒèŠ‚èƒ½åŠ›ï¼ˆ0=æœ€è–„/çœ‹è¿œï¼Œ100=æœ€åš/çœ‹è¿‘ï¼‰</small>
                    <div class="thickness-info" id="thicknessInfo">
                        å®é™…ç‰©ç†åšåº¦: <strong id="absoluteThicknessValue">50.0</strong>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="wearGlasses">
                        <label for="wearGlasses" style="margin: 0;">ä½©æˆ´çŸ«æ­£çœ¼é•œ</label>
                    </div>
                </div>
                
                <div class="control-group" id="glassPowerGroup" style="display: none;">
                    <label>
                        çœ¼é•œåº¦æ•°
                        <span class="value-display" id="glassPowerValue">0</span>
                    </label>
                    <input type="range" id="glassPower" min="-600" max="400" value="0" step="25">
                    <small style="color: #7f8c8d;">è´Ÿå€¼=å‡¹é€é•œï¼Œæ­£å€¼=å‡¸é€é•œ</small>
                </div>
                
                <div class="status-display">
                    <strong>æˆåƒçŠ¶æ€ï¼š</strong>
                    <p id="statusText" style="margin-top: 10px;">æ­£åœ¨è®¡ç®—...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('eyeCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ§åˆ¶å…ƒç´ 
        const eyeTypeSelect = document.getElementById('eyeType');
        const objectDistanceSlider = document.getElementById('objectDistance');
        const lensThicknessSlider = document.getElementById('lensThickness');
        const wearGlassesCheck = document.getElementById('wearGlasses');
        const glassPowerSlider = document.getElementById('glassPower');
        const glassPowerGroup = document.getElementById('glassPowerGroup');
        const autoAdjustBtn = document.getElementById('autoAdjustBtn');
        
        // æ˜¾ç¤ºå…ƒç´ 
        const distanceValue = document.getElementById('distanceValue');
        const thicknessValue = document.getElementById('thicknessValue');
        const absoluteThicknessValue = document.getElementById('absoluteThicknessValue');
        const glassPowerValue = document.getElementById('glassPowerValue');
        const statusText = document.getElementById('statusText');
        
        // çœ¼çƒå‚æ•°
        const EYE = {
            centerX: 550,
            centerY: 250,
            radius: 100,
            lensX: 470,
            retinaX: 640,
            eyeAxisLength: 3.4, // çœ¼è½´é•¿åº¦(cm)ï¼Œä»æ™¶çŠ¶ä½“åˆ°è§†ç½‘è†œ
        };
        
        // æ˜¾ç¤ºæ”¾å¤§ç³»æ•°ï¼ˆå…³é”®ä¿®æ”¹ï¼šæ”¾å¤§åƒä½ç½®çš„åå·®ï¼‰
        const DISPLAY_MAGNIFICATION = 5;
        
        // çŠ¶æ€å˜é‡
        let state = {
            eyeType: 'normal',
            objectDistance: 200,
            lensThickness: 50.0,  // ç›¸å¯¹åšåº¦ï¼ˆè°ƒèŠ‚èƒ½åŠ›ï¼‰0-100
            wearGlasses: false,
            glassPower: 0,
        };
        
        // ä¸åŒçœ¼ç›ç±»å‹çš„è°ƒèŠ‚èŒƒå›´ï¼ˆå…³é”®ï¼šç»å¯¹åšåº¦èŒƒå›´ï¼‰
        const EYE_PARAMS = {
            normal: {
                minAbsThickness: 20,  // è°ƒåˆ°æœ€è–„æ—¶çš„ç»å¯¹åšåº¦
                maxAbsThickness: 80,  // è°ƒåˆ°æœ€åšæ—¶çš„ç»å¯¹åšåº¦
                description: 'æ­£å¸¸çœ¼å¯ä»¥åœ¨è¾ƒå¤§èŒƒå›´å†…è°ƒèŠ‚'
            },
            myopia: {
                minAbsThickness: 50,  // è¿‘è§†çœ¼å³ä½¿è°ƒåˆ°æœ€è–„ï¼Œç»å¯¹åšåº¦ä¹Ÿæœ‰50
                maxAbsThickness: 100, // è°ƒåˆ°æœ€åšæ—¶çš„ç»å¯¹åšåº¦
                description: 'è¿‘è§†çœ¼æ™¶çŠ¶ä½“ååšï¼Œæ— æ³•è°ƒå¾—å¾ˆè–„'
            },
            hyperopia: {
                minAbsThickness: 0,   // è¿œè§†çœ¼è°ƒåˆ°æœ€è–„æ—¶çš„ç»å¯¹åšåº¦
                maxAbsThickness: 50,  // è¿œè§†çœ¼å³ä½¿è°ƒåˆ°æœ€åšï¼Œç»å¯¹åšåº¦ä¹Ÿåªæœ‰50
                description: 'è¿œè§†çœ¼æ™¶çŠ¶ä½“åè–„ï¼Œæ— æ³•è°ƒå¾—å¾ˆåš'
            }
        };
        
        // ç»å¯¹åšåº¦åˆ°ç„¦è·çš„æ˜ å°„ï¼ˆç»Ÿä¸€çš„ç‰©ç†è§„å¾‹ï¼‰
        function absoluteThicknessToFocal(absoluteThickness) {
            // absoluteThickness: 0-100
            // 0 = æœ€è–„ â†’ ç„¦è·æœ€é•¿ (4.0cm)
            // 100 = æœ€åš â†’ ç„¦è·æœ€çŸ­ (2.5cm)
            const minFocal = 2.5;  // æœ€åšæ—¶çš„ç„¦è·
            const maxFocal = 4.0;  // æœ€è–„æ—¶çš„ç„¦è·
            const t = absoluteThickness / 100;
            return maxFocal - t * (maxFocal - minFocal);
        }
        
        // ç„¦è·åˆ°ç»å¯¹åšåº¦çš„æ˜ å°„
        function focalToAbsoluteThickness(focal) {
            const minFocal = 2.5;
            const maxFocal = 4.0;
            // é™åˆ¶ç„¦è·èŒƒå›´
            focal = Math.max(minFocal, Math.min(maxFocal, focal));
            const t = (maxFocal - focal) / (maxFocal - minFocal);
            return t * 100;
        }
        
        // ç›¸å¯¹åšåº¦ï¼ˆæ»‘å—å€¼0-100ï¼‰è½¬æ¢ä¸ºç»å¯¹åšåº¦
        function relativeToAbsolute(relativeThickness, eyeType) {
            const params = EYE_PARAMS[eyeType];
            const t = relativeThickness / 100;
            return params.minAbsThickness + t * (params.maxAbsThickness - params.minAbsThickness);
        }
        
        // ç»å¯¹åšåº¦è½¬æ¢ä¸ºç›¸å¯¹åšåº¦
        function absoluteToRelative(absoluteThickness, eyeType) {
            const params = EYE_PARAMS[eyeType];
            // é™åˆ¶åœ¨è°ƒèŠ‚èŒƒå›´å†…
            absoluteThickness = Math.max(params.minAbsThickness, Math.min(params.maxAbsThickness, absoluteThickness));
            const t = (absoluteThickness - params.minAbsThickness) / (params.maxAbsThickness - params.minAbsThickness);
            return t * 100;
        }
        
        // äº‹ä»¶ç›‘å¬
        eyeTypeSelect.addEventListener('change', (e) => {
            state.eyeType = e.target.value;
            
            // æ ¹æ®çœ¼ç›ç±»å‹è°ƒæ•´å»ºè®®çœ¼é•œåº¦æ•°
            if (state.eyeType === 'myopia') {
                glassPowerSlider.value = -300;
                state.glassPower = -300;
            } else if (state.eyeType === 'hyperopia') {
                glassPowerSlider.value = 250;
                state.glassPower = 250;
            } else {
                glassPowerSlider.value = 0;
                state.glassPower = 0;
            }
            updateGlassPowerDisplay();
            updateAbsoluteThicknessDisplay();
            draw();
        });
        
        objectDistanceSlider.addEventListener('input', (e) => {
            state.objectDistance = parseInt(e.target.value);
            distanceValue.textContent = state.objectDistance;
            draw();
        });
        
        lensThicknessSlider.addEventListener('input', (e) => {
            state.lensThickness = parseFloat(e.target.value);
            thicknessValue.textContent = state.lensThickness.toFixed(1);
            updateAbsoluteThicknessDisplay();
            draw();
        });
        
        wearGlassesCheck.addEventListener('change', (e) => {
            state.wearGlasses = e.target.checked;
            glassPowerGroup.style.display = state.wearGlasses ? 'block' : 'none';
            draw();
        });
        
        glassPowerSlider.addEventListener('input', (e) => {
            state.glassPower = parseInt(e.target.value);
            updateGlassPowerDisplay();
            draw();
        });
        
        // è‡ªåŠ¨è°ƒèŠ‚æŒ‰é’®
        autoAdjustBtn.addEventListener('click', () => {
            autoAdjustLens();
        });
        
        function updateGlassPowerDisplay() {
            const power = state.glassPower;
            const type = power < 0 ? 'å‡¹é€é•œ' : power > 0 ? 'å‡¸é€é•œ' : 'å¹³å…‰';
            glassPowerValue.textContent = `${power}åº¦ (${type})`;
        }
        
        function updateAbsoluteThicknessDisplay() {
            const absThickness = relativeToAbsolute(state.lensThickness, state.eyeType);
            absoluteThicknessValue.textContent = absThickness.toFixed(1);
        }
        
        // è‡ªåŠ¨è°ƒèŠ‚æ™¶çŠ¶ä½“åšåº¦
        function autoAdjustLens() {
            const u = state.objectDistance; // ç‰©è·(cm)
            const v = EYE.eyeAxisLength; // åƒè·(cm) - å›ºå®šä¸ºçœ¼è½´é•¿åº¦
            
            // å¦‚æœæˆ´çœ¼é•œï¼Œéœ€è¦è€ƒè™‘çœ¼é•œçš„ä½œç”¨
            let effectiveU = u;
            if (state.wearGlasses && state.glassPower !== 0) {
                const fGlass = 10000 / state.glassPower; // çœ¼é•œç„¦è·(cm)
                const glassToLens = 2;
                const uGlass = u - glassToLens;
                
                if (Math.abs(uGlass - fGlass) > 0.1) {
                    const vGlass = (fGlass * uGlass) / (uGlass - fGlass);
                    
                    if (vGlass < 0) {
                        effectiveU = glassToLens + Math.abs(vGlass);
                    } else {
                        effectiveU = Math.abs(vGlass - glassToLens);
                    }
                }
            }
            
            // è®¡ç®—éœ€è¦çš„ç„¦è·ï¼š1/f = 1/u + 1/v â†’ f = uv/(u+v)
            const requiredFocal = (effectiveU * v) / (effectiveU + v);
            
            // å°†ç„¦è·è½¬æ¢ä¸ºç»å¯¹åšåº¦
            const requiredAbsThickness = focalToAbsoluteThickness(requiredFocal);
            
            const params = EYE_PARAMS[state.eyeType];
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è¯¥çœ¼ç›ç±»å‹çš„è°ƒèŠ‚èŒƒå›´å†…
            if (requiredAbsThickness < params.minAbsThickness || requiredAbsThickness > params.maxAbsThickness) {
                let message = '';
                if (state.eyeType === 'myopia') {
                    message = `âŒ è¿‘è§†çœ¼æ— æ³•çœ‹æ¸…è¯¥ç‰©ä½“ï¼\n\n`;
                    message += `éœ€è¦çš„ç„¦è·: ${requiredFocal.toFixed(2)}cm\n`;
                    message += `éœ€è¦çš„ç»å¯¹åšåº¦: ${requiredAbsThickness.toFixed(1)}\n`;
                    message += `ä½†è¿‘è§†çœ¼çš„è°ƒèŠ‚èŒƒå›´: ${params.minAbsThickness} - ${params.maxAbsThickness}\n\n`;
                    if (requiredAbsThickness < params.minAbsThickness) {
                        message += `ç‰©ä½“å¤ªè¿œï¼Œå³ä½¿è°ƒåˆ°æœ€è–„ï¼ˆç»å¯¹åšåº¦${params.minAbsThickness}ï¼‰ï¼Œä»æ— æ³•çœ‹æ¸…ã€‚\n`;
                        message += `éœ€è¦é…æˆ´å‡¹é€é•œçŸ«æ­£ï¼`;
                    }
                } else if (state.eyeType === 'hyperopia') {
                    message = `âŒ è¿œè§†çœ¼æ— æ³•çœ‹æ¸…è¯¥ç‰©ä½“ï¼\n\n`;
                    message += `éœ€è¦çš„ç„¦è·: ${requiredFocal.toFixed(2)}cm\n`;
                    message += `éœ€è¦çš„ç»å¯¹åšåº¦: ${requiredAbsThickness.toFixed(1)}\n`;
                    message += `ä½†è¿œè§†çœ¼çš„è°ƒèŠ‚èŒƒå›´: ${params.minAbsThickness} - ${params.maxAbsThickness}\n\n`;
                    if (requiredAbsThickness > params.maxAbsThickness) {
                        message += `ç‰©ä½“å¤ªè¿‘ï¼Œå³ä½¿è°ƒåˆ°æœ€åšï¼ˆç»å¯¹åšåº¦${params.maxAbsThickness}ï¼‰ï¼Œä»æ— æ³•çœ‹æ¸…ã€‚\n`;
                        message += `éœ€è¦é…æˆ´å‡¸é€é•œçŸ«æ­£ï¼`;
                    }
                } else {
                    message = `âš ï¸ ç‰©è·è¶…å‡ºæ­£å¸¸è°ƒèŠ‚èŒƒå›´ï¼\n`;
                    message += `éœ€è¦ç„¦è·: ${requiredFocal.toFixed(2)}cm\n`;
                    message += `éœ€è¦ç»å¯¹åšåº¦: ${requiredAbsThickness.toFixed(1)}\n`;
                    message += `è°ƒèŠ‚èŒƒå›´: ${params.minAbsThickness} - ${params.maxAbsThickness}`;
                }
                alert(message);
                return;
            }
            
            // å°†ç»å¯¹åšåº¦è½¬æ¢ä¸ºç›¸å¯¹åšåº¦
            const relativeThickness = absoluteToRelative(requiredAbsThickness, state.eyeType);
            
            // åº”ç”¨åšåº¦ï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
            animateThickness(state.lensThickness, relativeThickness);
        }
        
        // åŠ¨ç”»æ”¹å˜åšåº¦
        function animateThickness(from, to) {
            const duration = 500; // ms
            const steps = 30;
            const stepTime = duration / steps;
            const increment = (to - from) / steps;
            let current = from;
            let step = 0;
            
            const interval = setInterval(() => {
                step++;
                current += increment;
                
                if (step >= steps) {
                    current = to;
                    clearInterval(interval);
                }
                
                state.lensThickness = current;
                lensThicknessSlider.value = current;
                thicknessValue.textContent = current.toFixed(1);
                updateAbsoluteThicknessDisplay();
                draw();
            }, stepTime);
        }
        
        // è®¡ç®—å½“å‰æ™¶çŠ¶ä½“ç„¦è·
        function calculateLensFocalLength() {
            const absThickness = relativeToAbsolute(state.lensThickness, state.eyeType);
            return absoluteThicknessToFocal(absThickness);
        }
        
        // è®¡ç®—çœ¼é•œç„¦è·
        function calculateGlassFocalLength() {
            if (!state.wearGlasses || state.glassPower === 0) {
                return Infinity;
            }
            return 10000 / state.glassPower;
        }
        
        // è®¡ç®—æˆåƒä½ç½®ï¼ˆå®é™…ç‰©ç†ä½ç½®ï¼‰
        function calculateImagePosition() {
            const u = state.objectDistance;
            const fLens = calculateLensFocalLength();
            
            let effectiveU = u;
            if (state.wearGlasses && state.glassPower !== 0) {
                const fGlass = calculateGlassFocalLength();
                const glassToLens = 2;
                const uGlass = u - glassToLens;
                
                if (Math.abs(uGlass - fGlass) > 0.01) {
                    const vGlass = (fGlass * uGlass) / (uGlass - fGlass);
                    
                    if (vGlass < 0) {
                        effectiveU = glassToLens + Math.abs(vGlass);
                    } else {
                        effectiveU = Math.abs(vGlass - glassToLens);
                    }
                }
            }
            
            if (Math.abs(effectiveU - fLens) < 0.01) {
                return 1000; // æ— é™è¿œ
            }
            
            const v = (fLens * effectiveU) / (effectiveU - fLens);
            return v;
        }
        
        // è®¡ç®—æ˜¾ç¤ºç”¨çš„æˆåƒä½ç½®ï¼ˆæ”¾å¤§åå·®ï¼‰
        function calculateDisplayImagePosition() {
            const actualImagePos = calculateImagePosition();
            const retinaPos = EYE.eyeAxisLength;
            const diff = actualImagePos - retinaPos;
            
            // æ”¾å¤§åå·®ï¼Œä¾¿äºè§‚å¯Ÿ
            const displayImagePos = retinaPos + diff * DISPLAY_MAGNIFICATION;
            
            return {
                actual: actualImagePos,
                display: displayImagePos
            };
        }
        
        // ç»˜åˆ¶å‡½æ•°
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawObject();
            drawEyeBall();
            drawRetina();
            drawLens();
            
            if (state.wearGlasses) {
                drawGlasses();
            }
            
            drawLightRays();
            drawImagePosition();
            updateStatus();
            drawLabels();
        }
        
        // ç»˜åˆ¶ç‰©ä½“ï¼ˆç‚¹å…‰æºï¼‰
        function drawObject() {
            const maxDistance = 500;
            const minDistance = 20;
            const leftMargin = 50;
            const maxObjectX = EYE.lensX - 80;
            
            const objectX = maxObjectX - ((state.objectDistance - minDistance) / (maxDistance - minDistance)) * (maxObjectX - leftMargin);
            const objectY = EYE.centerY;
            
            // ç»˜åˆ¶ç‚¹å…‰æº
            ctx.fillStyle = '#f39c12';
            ctx.strokeStyle = '#d68910';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(objectX, objectY, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // å‘å…‰æ•ˆæœ
            const gradient = ctx.createRadialGradient(objectX, objectY, 0, objectX, objectY, 20);
            gradient.addColorStop(0, 'rgba(243, 156, 18, 0.6)');
            gradient.addColorStop(1, 'rgba(243, 156, 18, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(objectX, objectY, 20, 0, Math.PI * 2);
            ctx.fill();
            
            // ç‰©è·æ ‡æ³¨çº¿
            ctx.strokeStyle = '#95a5a6';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(objectX, objectY + 35);
            ctx.lineTo(EYE.lensX - 40, objectY + 35);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç‰©è·æ–‡å­—
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`ç‰©è·: ${state.objectDistance}cm`, (objectX + EYE.lensX - 40) / 2, objectY + 50);
            ctx.textAlign = 'left';
            
            return objectX;
        }
        
        function drawEyeBall() {
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'rgba(200, 220, 240, 0.2)';
            ctx.beginPath();
            ctx.arc(EYE.centerX, EYE.centerY, EYE.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
        }
        
        function drawLens() {
            const lensX = EYE.lensX;
            const lensY = EYE.centerY;
            
            // åŸºç¡€å®½åº¦
            const baseWidth = 10;
            
            // æ ¹æ®ç»å¯¹åšåº¦è®¡ç®—æ˜¾ç¤ºå®½åº¦ï¼ˆå…³é”®ï¼šæ‰€æœ‰çœ¼ç›ç±»å‹ä½¿ç”¨ç›¸åŒçš„æ˜ å°„ï¼‰
            const absThickness = relativeToAbsolute(state.lensThickness, state.eyeType);
            const width = baseWidth + (absThickness / 100) * 25; // ç»å¯¹åšåº¦0â†’å®½åº¦10ï¼Œç»å¯¹åšåº¦100â†’å®½åº¦35
            const height = 50;
            
            // æ™¶çŠ¶ä½“ï¼ˆæ£•è‰²ï¼‰
            ctx.fillStyle = 'rgba(139, 115, 85, 0.75)';
            ctx.strokeStyle = 'rgba(101, 84, 63, 0.9)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(lensX, lensY, Math.max(width, 5), height, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // ç»†èŠ‚çº¹ç†
            ctx.strokeStyle = 'rgba(80, 60, 40, 0.4)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.ellipse(lensX - 2, lensY, Math.max(width * 0.5, 3), height * 0.8, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(lensX + 2, lensY, Math.max(width * 0.5, 3), height * 0.8, 0, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        function drawRetina() {
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(EYE.centerX, EYE.centerY, EYE.radius - 8, -0.55, 0.55);
            ctx.stroke();
        }
        
        function drawGlasses() {
            const glassX = EYE.lensX - 40;
            const glassY = EYE.centerY;
            
            if (state.glassPower < 0) {
                // å‡¹é€é•œ
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(glassX - 10, glassY, 45, -0.35, 0.35);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(glassX + 10, glassY, 45, Math.PI - 0.35, Math.PI + 0.35);
                ctx.stroke();
                
                ctx.fillStyle = '#9b59b6';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('å‡¹é€é•œ', glassX - 20, glassY - 60);
            } else if (state.glassPower > 0) {
                // å‡¸é€é•œ
                ctx.strokeStyle = '#e67e22';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(glassX + 10, glassY, 45, Math.PI - 0.35, Math.PI + 0.35);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(glassX - 10, glassY, 45, -0.35, 0.35);
                ctx.stroke();
                
                ctx.fillStyle = '#e67e22';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('å‡¸é€é•œ', glassX - 20, glassY - 60);
            }
        }
        
        function drawLightRays() {
            const objectX = EYE.lensX - 80 - ((state.objectDistance - 20) / 480) * (EYE.lensX - 130);
            const lensX = EYE.lensX;
            
            // 5æ¡å…‰çº¿
            const rays = [
                { angle: -0.12 },
                { angle: -0.06 },
                { angle: 0 },
                { angle: 0.06 },
                { angle: 0.12 }
            ];
            
            rays.forEach(ray => {
                const startY = EYE.centerY;
                const dx = lensX - objectX;
                const arriveY = startY + dx * Math.tan(ray.angle);
                
                // å…¥å°„å…‰çº¿
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(objectX, startY);
                
                if (state.wearGlasses) {
                    const glassX = lensX - 40;
                    const glassArriveY = startY + (glassX - objectX) * Math.tan(ray.angle);
                    ctx.lineTo(glassX, glassArriveY);
                    ctx.stroke();
                    
                    // çœ¼é•œæŠ˜å°„
                    let newAngle = ray.angle;
                    if (state.glassPower < 0) {
                        const divergence = (glassArriveY - EYE.centerY) * 0.0006 * Math.abs(state.glassPower);
                        newAngle += divergence;
                    } else if (state.glassPower > 0) {
                        const convergence = (glassArriveY - EYE.centerY) * 0.0006 * state.glassPower;
                        newAngle -= convergence;
                    }
                    
                    const dx2 = lensX - glassX;
                    const newArriveY = glassArriveY + dx2 * Math.tan(newAngle);
                    
                    ctx.strokeStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.moveTo(glassX, glassArriveY);
                    ctx.lineTo(lensX, newArriveY);
                    ctx.stroke();
                    
                    drawRefractedRay(lensX, newArriveY);
                } else {
                    ctx.lineTo(lensX, arriveY);
                    ctx.stroke();
                    
                    drawRefractedRay(lensX, arriveY);
                }
            });
        }
        
        function drawRefractedRay(startX, startY) {
            const imagePosData = calculateDisplayImagePosition();
            const pixelPerCm = (EYE.retinaX - EYE.lensX) / EYE.eyeAxisLength;
            const imagePosX = EYE.lensX + imagePosData.display * pixelPerCm;
            const imagePosY = EYE.centerY;
            
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(Math.min(Math.max(imagePosX, EYE.lensX + 10), canvas.width - 20), imagePosY);
            ctx.stroke();
            
            // å»¶é•¿è™šçº¿
            const retinaPixelX = EYE.retinaX;
            if (Math.abs(imagePosX - retinaPixelX) > 5) {
                ctx.setLineDash([4, 4]);
                ctx.strokeStyle = 'rgba(231, 76, 60, 0.3)';
                ctx.beginPath();
                
                if (imagePosX < retinaPixelX) {
                    ctx.moveTo(imagePosX, imagePosY);
                    ctx.lineTo(retinaPixelX + 40, imagePosY);
                } else {
                    const endX = Math.min(imagePosX + 30, canvas.width - 10);
                    ctx.moveTo(imagePosX, imagePosY);
                    ctx.lineTo(endX, imagePosY);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        function drawImagePosition() {
            const imagePosData = calculateDisplayImagePosition();
            const pixelPerCm = (EYE.retinaX - EYE.lensX) / EYE.eyeAxisLength;
            let imagePosX = EYE.lensX + imagePosData.display * pixelPerCm;
            
            // é™åˆ¶æ˜¾ç¤ºèŒƒå›´
            imagePosX = Math.min(Math.max(imagePosX, EYE.lensX + 20), canvas.width - 30);
            const imagePosY = EYE.centerY;
            
            // æˆåƒç‚¹
            ctx.fillStyle = '#27ae60';
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(imagePosX, imagePosY, 7, 0, Math.PI * 2);
            ctx.fill();
            
            // æˆåƒä½ç½®çº¿
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(imagePosX, imagePosY - 65);
            ctx.lineTo(imagePosX, imagePosY + 65);
            ctx.stroke();
            
            ctx.fillStyle = '#27ae60';
            ctx.font = 'bold 13px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('åƒ', imagePosX, imagePosY + 82);
            ctx.textAlign = 'left';
        }
        
        function drawLabels() {
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 13px Arial';
            
            ctx.fillText('æ™¶çŠ¶ä½“', EYE.lensX - 18, EYE.centerY - 75);
            ctx.fillText('è§†ç½‘è†œ', EYE.retinaX - 18, EYE.centerY + 80);
        }
        
        function updateStatus() {
            const imagePosData = calculateDisplayImagePosition();
            const imagePos = imagePosData.actual;  // å®é™…åƒè·
            const retinaPos = EYE.eyeAxisLength;
            const diff = Math.abs(imagePos - retinaPos);
            
            let status = '';
            let focal = calculateLensFocalLength();
            const absThickness = relativeToAbsolute(state.lensThickness, state.eyeType);
            const params = EYE_PARAMS[state.eyeType];
            
            if (diff < 0.15) {
                status = `<strong style="color: #27ae60;">âœ“ æˆåƒæ¸…æ™°ï¼</strong><br>
                    åƒè· â‰ˆ ${imagePos.toFixed(2)} cm â‰ˆ è§†ç½‘è†œä½ç½® ${retinaPos.toFixed(2)} cm<br>
                    æ™¶çŠ¶ä½“ç„¦è·: ${focal.toFixed(2)} cm | ç»å¯¹åšåº¦: ${absThickness.toFixed(1)}<br>
                    <small>å…‰çº¿æ°å¥½æ±‡èšåœ¨è§†ç½‘è†œä¸Šï¼Œå¯ä»¥çœ‹æ¸…ç‰©ä½“ã€‚</small>`;
            } else if (imagePos < retinaPos) {
                const diffCm = (retinaPos - imagePos).toFixed(2);
                status = `<strong style="color: #e74c3c;">âœ— æˆåƒåœ¨è§†ç½‘è†œå‰æ–¹ï¼ˆæ¨¡ç³Šï¼‰</strong><br>
                    åƒè· â‰ˆ ${imagePos.toFixed(2)} cm < è§†ç½‘è†œ ${retinaPos.toFixed(2)} cm<br>
                    <strong>åå·®: ${diffCm}cmï¼ˆç”»å¸ƒå·²æ”¾å¤§${DISPLAY_MAGNIFICATION}å€æ˜¾ç¤ºï¼‰</strong><br>
                    æ™¶çŠ¶ä½“ç„¦è·: ${focal.toFixed(2)} cm | ç»å¯¹åšåº¦: ${absThickness.toFixed(1)}<br>
                    <small>ç»å¯¹åšåº¦èŒƒå›´: ${params.minAbsThickness} - ${params.maxAbsThickness}</small><br>`;
                
                if (state.eyeType === 'myopia') {
                    status += '<small><strong>è¿‘è§†çœ¼ï¼š</strong>æ™¶çŠ¶ä½“ååšï¼Œçœ‹è¿œå¤„æ—¶åƒæ€»åœ¨è§†ç½‘è†œå‰ã€‚éœ€è¦<strong>å‡¹é€é•œ</strong>çŸ«æ­£ã€‚</small>';
                } else {
                    status += '<small>æ™¶çŠ¶ä½“å¤ªåšï¼Œå°è¯•<strong>å‡å°åšåº¦</strong>æˆ–ç‚¹å‡»è‡ªåŠ¨è°ƒèŠ‚ã€‚</small>';
                }
            } else {
                const diffCm = (imagePos - retinaPos).toFixed(2);
                status = `<strong style="color: #e74c3c;">âœ— æˆåƒåœ¨è§†ç½‘è†œåæ–¹ï¼ˆæ¨¡ç³Šï¼‰</strong><br>
                    åƒè· â‰ˆ ${imagePos.toFixed(2)} cm > è§†ç½‘è†œ ${retinaPos.toFixed(2)} cm<br>
                    <strong>åå·®: ${diffCm}cmï¼ˆç”»å¸ƒå·²æ”¾å¤§${DISPLAY_MAGNIFICATION}å€æ˜¾ç¤ºï¼‰</strong><br>
                    æ™¶çŠ¶ä½“ç„¦è·: ${focal.toFixed(2)} cm | ç»å¯¹åšåº¦: ${absThickness.toFixed(1)}<br>
                    <small>ç»å¯¹åšåº¦èŒƒå›´: ${params.minAbsThickness} - ${params.maxAbsThickness}</small><br>`;
                
                if (state.eyeType === 'hyperopia') {
                    status += '<small><strong>è¿œè§†çœ¼ï¼š</strong>æ™¶çŠ¶ä½“åè–„ï¼Œçœ‹è¿‘å¤„æ—¶åƒæ€»åœ¨è§†ç½‘è†œåã€‚éœ€è¦<strong>å‡¸é€é•œ</strong>çŸ«æ­£ã€‚</small>';
                } else {
                    status += '<small>æ™¶çŠ¶ä½“å¤ªè–„ï¼Œå°è¯•<strong>å¢åŠ åšåº¦</strong>æˆ–ç‚¹å‡»è‡ªåŠ¨è°ƒèŠ‚ã€‚</small>';
                }
            }
            
            statusText.innerHTML = status;
        }
        
        // åˆå§‹åŒ–
        updateAbsoluteThicknessDisplay();
        draw();
    </script>
</body>
</html>
